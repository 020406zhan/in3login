"use strict";const R=require("express"),I=require("@lark-base-open/node-sdk"),k=require("axios"),S={},x="HFBKbSAqwa9NHWscfttcZ4FhnUe",j="pt-D3eHlTlIiYvoWI3MVclqddbbUZ1fiz9UZzn2mmiYAQAAAgCD9hNAj5WjYty7",C="tblA4weHVn8xvU3U";function q(){var h=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],g=[82,9,106,213,48,54,165,56,191,64,163,158,129,243,215,251,124,227,57,130,155,47,255,135,52,142,67,68,196,222,233,203,84,123,148,50,166,194,35,61,238,76,149,11,66,250,195,78,8,46,161,102,40,217,36,178,118,91,162,73,109,139,209,37,114,248,246,100,134,104,152,22,212,164,92,204,93,101,182,146,108,112,72,80,253,237,185,218,94,21,70,87,167,141,157,132,144,216,171,0,140,188,211,10,247,228,88,5,184,179,69,6,208,44,30,143,202,63,15,2,193,175,189,3,1,19,138,107,58,145,17,65,79,103,220,234,151,242,207,206,240,180,230,115,150,172,116,34,231,173,53,133,226,249,55,232,28,117,223,110,71,241,26,113,29,41,197,137,111,183,98,14,170,24,190,27,252,86,62,75,198,210,121,32,154,219,192,254,120,205,90,244,31,221,168,51,136,7,199,49,177,18,16,89,39,128,236,95,96,81,127,169,25,181,74,13,45,229,122,159,147,201,156,239,160,224,59,77,174,42,245,176,200,235,187,60,131,83,153,97,23,43,4,126,186,119,214,38,225,105,20,99,85,33,12,125],d=[1,2,4,8,16,32,64,128,27,54];function w(a){for(var n=unescape(encodeURIComponent(a)),e=[],r=0;r<n.length;r++)e.push(n.charCodeAt(r));return e}function u(a){for(var n="",e=0;e<a.length;e++)n+=String.fromCharCode(a[e]);return decodeURIComponent(escape(n))}function E(a){for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e="",r=0;r<a.length;){var i=a[r++]||0,t=a[r++]||0,l=a[r++]||0,c=i<<16|t<<8|l;e+=n.charAt(c>>18&63),e+=n.charAt(c>>12&63),e+=r-2<a.length?n.charAt(c>>6&63):"=",e+=r-1<a.length?n.charAt(c&63):"="}return e}function U(a){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=[],r=0;for(a=a.replace(/[^A-Za-z0-9+/]/g,"");r<a.length;){var i=n.indexOf(a.charAt(r++)),t=n.indexOf(a.charAt(r++)),l=n.indexOf(a.charAt(r++)),c=n.indexOf(a.charAt(r++)),v=i<<18|t<<12|l<<6|c;e.push(v>>16&255),l!==64&&e.push(v>>8&255),c!==64&&e.push(v&255)}return e}function y(a){for(var n=16-a.length%16,e=a.slice(),r=0;r<n;r++)e.push(n);return e}function D(a){if(a.length===0)return a;var n=a[a.length-1];return n>16||n>a.length?a:a.slice(0,a.length-n)}function s(a,n){for(var e=0,r=0;r<8;r++){n&1&&(e^=a);var i=(a&128)!==0;a<<=1,i&&(a^=27),n>>=1}return e&255}function p(a){for(var n=[],e=0;e<16;)n[e]=a[e],e++;for(;e<176;){var r=[n[e-4],n[e-3],n[e-2],n[e-1]];if(e%16===0){var i=r[0];r[0]=r[1],r[1]=r[2],r[2]=r[3],r[3]=i,r[0]=h[r[0]],r[1]=h[r[1]],r[2]=h[r[2]],r[3]=h[r[3]],r[0]^=d[e/16-1]}n[e]=n[e-16]^r[0],n[e+1]=n[e+1-16]^r[1],n[e+2]=n[e+2-16]^r[2],n[e+3]=n[e+3-16]^r[3],e+=4}return n}function B(a,n){for(var e=a.slice(),r=0;r<16;r++)e[r]^=n[r];for(var i=1;i<=9;i++){for(var r=0;r<16;r++)e[r]=h[e[r]];var o=e[1];e[1]=e[5],e[5]=e[9],e[9]=e[13],e[13]=o,o=e[2],e[2]=e[10],e[10]=o,o=e[6],e[6]=e[14],e[14]=o,o=e[3],e[3]=e[15],e[15]=e[11],e[11]=e[7],e[7]=o;for(var t=0;t<4;t++){var l=e[t*4],c=e[t*4+1],v=e[t*4+2],f=e[t*4+3];e[t*4]=s(l,2)^s(c,3)^v^f,e[t*4+1]=l^s(c,2)^s(v,3)^f,e[t*4+2]=l^c^s(v,2)^s(f,3),e[t*4+3]=s(l,3)^c^v^s(f,2)}for(var r=0;r<16;r++)e[r]^=n[i*16+r]}for(var r=0;r<16;r++)e[r]=h[e[r]];var o=e[1];e[1]=e[5],e[5]=e[9],e[9]=e[13],e[13]=o,o=e[2],e[2]=e[10],e[10]=o,o=e[6],e[6]=e[14],e[14]=o,o=e[3],e[3]=e[15],e[15]=e[11],e[11]=e[7],e[7]=o;for(var r=0;r<16;r++)e[r]^=n[160+r];return e}function A(a,n){for(var e=a.slice(),r=0;r<16;r++)e[r]^=n[160+r];for(var i=9;i>=1;i--){var o=e[13];e[13]=e[9],e[9]=e[5],e[5]=e[1],e[1]=o,o=e[2],e[2]=e[10],e[10]=o,o=e[6],e[6]=e[14],e[14]=o,o=e[7],e[7]=e[11],e[11]=e[15],e[15]=e[3],e[3]=o;for(var r=0;r<16;r++)e[r]=g[e[r]];for(var r=0;r<16;r++)e[r]^=n[i*16+r];for(var t=0;t<4;t++){var l=e[t*4],c=e[t*4+1],v=e[t*4+2],f=e[t*4+3];e[t*4]=s(l,14)^s(c,11)^s(v,13)^s(f,9),e[t*4+1]=s(l,9)^s(c,14)^s(v,11)^s(f,13),e[t*4+2]=s(l,13)^s(c,9)^s(v,14)^s(f,11),e[t*4+3]=s(l,11)^s(c,13)^s(v,9)^s(f,14)}}var o=e[13];e[13]=e[9],e[9]=e[5],e[5]=e[1],e[1]=o,o=e[2],e[2]=e[10],e[10]=o,o=e[6],e[6]=e[14],e[14]=o,o=e[7],e[7]=e[11],e[11]=e[15],e[15]=e[3],e[3]=o;for(var r=0;r<16;r++)e[r]=g[e[r]];for(var r=0;r<16;r++)e[r]^=n[r];return e}return{encrypt:function(a,n){var e=w(a),r=w(n);if(r.length<16)for(;r.length<16;)r.push(0);else r.length>16&&(r=r.slice(0,16));for(var i=y(e),t=p(r),l=[],c=0;c<i.length;c+=16){var v=i.slice(c,c+16),f=B(v,t);l=l.concat(f)}return E(l)},decrypt:function(a,n){var e=U(a),r=w(n);if(r.length<16)for(;r.length<16;)r.push(0);else r.length>16&&(r=r.slice(0,16));for(var i=p(r),t=[],l=0;l<e.length;l+=16){var c=e.slice(l,l+16),v=A(c,i);t=t.concat(v)}var f=D(t);return u(f)}}}async function N(){var y;const h=new I.BaseClient({appToken:x,personalBaseToken:j});new I.BaseClient({});const d=((y=(await h.base.appTableRecord.list({path:{table_id:C},params:{filter:'CurrentValue.[系统编码] = "IN3"'}})).data)==null?void 0:y.items)||[];if(d.length!==1)throw new Error("系统编码为IN3的记录数量有误");const w=d[0],u=w.fields;console.log(u);const E=u.AK日期;if(!E||!u.AK||!u.USER_ID||new Date(E).getTime()<Date.now()-2*60*60*1e3){console.log("需要重新登录");const s=q().encrypt(u.密码,"HGY12345HGY12345"),p={server:u.接口地址,username:encodeURIComponent(`corp:${u.用户名}@${u.租户CODE}`),password:encodeURIComponent(s),client_id:u.CLIENT_ID,client_secret:u.CLIENT_SECRET},B=`${p.server}/service/uaas/oauth/token?username=${p.username}&password=${p.password}&grant_type=password&client_id=${p.client_id}&client_secret=${p.client_secret}`;console.log("登录地址：",B);const A=await k.get(B,{headers:{Accept:"application/json"},timeout:2e4});console.log(A.data),console.log(w);const a=A.data;if(A.status===200){const n=new Map([["AK",String(a.access_token)],["AK日期",Date.now()],["USER_ID",String(a.user_id)]]);console.log(n);const e=await h.base.appTableRecord.update({path:{table_id:C,record_id:w.record_id},data:{fields:Object.fromEntries(n)}});console.log(C),console.log(e),console.log("登录成功，已更新表格记录")}else throw new Error("fetch err! status is "+A.status)}else console.log("已登录，使用已有 token 访问")}const _=R(),T=3e3;_.use(R.json());_.use(R.static("."));_.get("/",(h,g)=>{g.sendFile(S.join(__dirname,"../index.html"))});_.get("/login",async(h,g)=>{try{await N(),g.json({success:!0,message:"登录成功"})}catch(d){console.error("登录失败:",d),g.status(500).json({success:!1,error:d instanceof Error?d.message:"登录失败"})}});_.listen(T,()=>{console.log("Listening on port: "+T)});
